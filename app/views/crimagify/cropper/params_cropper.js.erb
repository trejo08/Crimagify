<% if @img.has_key?(:parent_fieldset)  %>	
	if ($("#<%=j @img[:parent_fieldset] %>").find(".<%=j @img[:parent_element_id] %>").find(".parent_image").length) {
		var $fieldset = $("#<%=j @img[:parent_fieldset] %>");
		var data = {
			time: $fieldset.attr("id").split("_")[1],
			parentobject: $fieldset.closest(".nested_crimagify_images").data("parentobject"),
			parent: $fieldset.closest(".nested_crimagify_images").data("parent")
		};
		var $areaImg = $fieldset.find(".<%=j @img[:parent_element_id] %>");
		if ($areaImg.find(".image_profile").length) {
			$areaImg.find(".image_profile").remove();
			$areaImg.find(".parent_image").append("<%=j render :partial => 'crimagify/crop_partials/img_final', :object => @img, :locals => { :f => 'f' } %>");
			$areaImg.find(".<%=j @img[:parent_element_id] %>_image_temporal").attr("value", "<%= @img[:path_image] %>");
			$fieldset.find(".id_images").attr("value", array_names);
			$areaImg.find(".<%=j @img[:parent_element_id] %>_crop_x").attr("value", "<%= @img[:crop_x] %>");
			$areaImg.find(".<%=j @img[:parent_element_id] %>_crop_y").attr("value", "<%= @img[:crop_y] %>");
			$areaImg.find(".<%=j @img[:parent_element_id] %>_crop_w").attr("value", "<%= @img[:crop_w] %>");
			$areaImg.find(".<%=j @img[:parent_element_id] %>_crop_h").attr("value", "<%= @img[:crop_h] %>");
		} else{
			$areaImg.find(".img_start").parents('div.crimagify_default_image').hide("slow", function(){});			
			$areaImg.find(".parent_image").append("<%=j render :partial => 'crimagify/crop_partials/img_final', :object => @img, :locals => { :f => 'f' } %>");
			$areaImg.find(".<%=j @img[:parent_element_id] %>_image_temporal").attr("value", "<%= @img[:path_image] %>");
			$areaImg.find(".id_images").attr("value", array_names);
			$areaImg.find(".parent_image").append("<input class='<%=j @img[:parent_element_id] %>_crop_x' name='"+data.parentobject+"["+data.parent+"_attributes]["+data.time+"][<%=j @img[:parent_element_id] %>_crop_x]' type='hidden' value='<%= @img[:crop_x] %>'>");
			$areaImg.find(".parent_image").append("<input class='<%=j @img[:parent_element_id] %>_crop_y' name='"+data.parentobject+"["+data.parent+"_attributes]["+data.time+"][<%=j @img[:parent_element_id] %>_crop_y]' type='hidden' value='<%= @img[:crop_y] %>'>");
			$areaImg.find(".parent_image").append("<input class='<%=j @img[:parent_element_id] %>_crop_w' name='"+data.parentobject+"["+data.parent+"_attributes]["+data.time+"][<%=j @img[:parent_element_id] %>_crop_w]' type='hidden' value='<%= @img[:crop_w] %>'>");
			$areaImg.find(".parent_image").append("<input class='<%=j @img[:parent_element_id] %>_crop_h' name='"+data.parentobject+"["+data.parent+"_attributes]["+data.time+"][<%=j @img[:parent_element_id] %>_crop_h]' type='hidden' value='<%= @img[:crop_h] %>'>");
		}
		$areaImg.find(".nested_uploader").val('');
	}
<% else %>
	var $parent = $("#<%=j @img[:parent_element_id] %>");	
	if ($parent.find(".parent_image").length) {
		if ($parent.find(".image_profile").length) {
			$parent.find(".image_profile").remove();
			$parent.find(".parent_image").append("<%=j render :partial => 'crimagify/crop_partials/img_final', :object => @img, :locals => { :f => 'f' } %>");
			$parent.find(".<%=j @img[:parent_element_id] %>_image_temporal").attr("value", "<%= @img[:path_image] %>");
			$("#id_images").attr("value", array_names);
			$parent.find("#<%=j @img[:parent_element_id] %>_crop_x").attr("value", "<%= @img[:crop_x] %>");
			$parent.find("#<%=j @img[:parent_element_id] %>_crop_y").attr("value", "<%= @img[:crop_y] %>");
			$parent.find("#<%=j @img[:parent_element_id] %>_crop_w").attr("value", "<%= @img[:crop_w] %>");
			$parent.find("#<%=j @img[:parent_element_id] %>_crop_h").attr("value", "<%= @img[:crop_h] %>");
		} else{
			$parent.find(".img_start").parents('div.crimagify_default_image').hide("slow", function(){});	
			$parent.find(".parent_image").append("<%=j render :partial => 'crimagify/crop_partials/img_final', :object => @img, :locals => { :f => 'f' } %>");
			$parent.find(".<%=j @img[:parent_element_id] %>_image_temporal").attr("value", "<%= @img[:path_image] %>");
			$("#id_images").attr("value", array_names);
			var parent_image = "<%=j @img[:data_parent].class.name.demodulize.downcase %>";
			// var parent_image_split = parent_image.split("/");
			// if (parent_image_split.length>1) {
			// 	parent_image = parent_image_split[1];
			// };
			// console.dir(parent_image);
			$parent.find("#parent_image").append("<input id='<%=j @img[:parent_element_id] %>_crop_x' name='"+parent_image+"[<%=j @img[:parent_element_id] %>_crop_x]' type='hidden' value='<%= @img[:crop_x] %>'>");
			$parent.find("#parent_image").append("<input id='<%=j @img[:parent_element_id] %>_crop_y' name='"+parent_image+"[<%=j @img[:parent_element_id] %>_crop_y]' type='hidden' value='<%= @img[:crop_y] %>'>");
			$parent.find("#parent_image").append("<input id='<%=j @img[:parent_element_id] %>_crop_w' name='"+parent_image+"[<%=j @img[:parent_element_id] %>_crop_w]' type='hidden' value='<%= @img[:crop_w] %>'>");
			$parent.find("#parent_image").append("<input id='<%=j @img[:parent_element_id] %>_crop_h' name='"+parent_image+"[<%=j @img[:parent_element_id] %>_crop_h]' type='hidden' value='<%= @img[:crop_h] %>'>");
			console.log("aqui imprimo los parametros crop")
			console.dir("#<%=j @img[:parent_element_id] %>_crop_x")
			console.dir("#<%=j @img[:parent_element_id] %>_crop_y")
			console.dir("#<%=j @img[:parent_element_id] %>_crop_w")
			console.dir("#<%=j @img[:parent_element_id] %>_crop_h")
			console.log("aqui imprim√≠ los parametros crop")
		}
		$parent.find(".uploader").val('');
	}
<% end %>
